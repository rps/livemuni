/*! livemuni 15-11-2013 */
var lm={config:{map:{el:"#map-canvas",center:new google.maps.LatLng(37.783,-122.409),zoom:15,maxZoom:18,minZoom:14,streetViewControl:!1,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,styles:[{featureType:"poi.business",elementType:"all",stylers:[{visibility:"off"}]}]},offset:10,direction:{},timeout:!0},init:function(){lm.app=new lm.App(lm.config)},hasDirection:function(a){return this.config.direction[a]},util:{}};lm.util.extend=function(){for(var a=arguments[0],b=1;b<arguments.length;b++)for(var c in arguments[b])a[c]=arguments[b][c];return a},lm.App=function(a){this.lastTime=0,this.lastBusArray=[],this.lastRouteArray=[],this.lastStopObjArray=[],this.userloc,this.destloc,this.map=new lm.Map(lm.util.extend(a.map,{ready:this.setupMap.bind(this)}))},lm.App.prototype.setupMap=function(){this.fetchAndRenderVehicles(),setInterval(this.fetchAndRenderVehicles.bind(this),1e4)},lm.App.prototype.set=function(a,b){this[a]=b},lm.App.prototype.fetchAndRenderVehicles=function(){this.map.midpoint=this.map.gMap.getCenter();var a=this.map.getBounds(),b=a.getSouthWest(),c=a.getNorthEast(),d=(this.map.projection,this),e="http://webservices.nextbus.com/service/publicXMLFeed?command=vehicleLocations&a=sf-muni&t=";d3.xhr(e+"0",function(a,e){if(a)return console.error("Error: ",a),void 0;for(var f=[],g=new XmlDocument(e.response),h=0;h<g.children.length;h++)"lastTime"===g.children[h].name&&(d.lastTime=g.children[h].attr.time),(!d.lastRouteArray.length||d.lastRouteArray.indexOf(g.children[h].attr.routeTag+":"+g.children[h].attr.dirTag)>-1)&&b.lat()-.01<=Number(g.children[h].attr.lat)&&Number(g.children[h].attr.lat)<=c.lat()+.01&&b.lng()-.01<=Number(g.children[h].attr.lon)&&Number(g.children[h].attr.lon)<=c.lng()+.01&&g.children[h].attr.secsSinceReport&&g.children[h].attr.secsSinceReport<180&&g.children[h].attr.dirTag&&(lm.hasDirection(g.children[h].attr.routeTag+":"+g.children[h].attr.dirTag)||0===Object.keys(lm.config.direction).length)&&f.push(g.children[h].attr);d.lastBusArray=f,d.adjustItemsOnMap(1)})},lm.App.prototype.getStopPredictions=function(a){var b,c="http://webservices.nextbus.com/service/publicXMLFeed?command=predictionsForMultiStops&a=sf-muni",d=this.map,e=this;this.lastRouteArray=[],this.lastStopObjArray=[];for(var f in a)this.lastRouteArray.push(f),b=f.slice(0,f.indexOf(":")),c+="&stops="+b+"|"+a[f].user.stopTag+"&stops="+b+"|"+a[f].dest.stopTag;d3.xhr(c,function(b,c){b&&console.error("Prediction error: ",b);var f,g,h,i,j=new XmlDocument(c.response),k=j.children.length,l={},m=[];j.eachChild(function(b){if(k--,f=b.attr.stopTag,g=b.attr.routeTag,b.children.length>0){if(h=b.children[0].attr.title,"message"!==b.children[0].name){var c=b.children[0].children[0].attr.minutes,j=b.children[0].children[0].attr.dirTag;a[g+":"+j]&&(i=a[g+":"+j].dest.stopTag===f?"dest":"user",lat=a[g+":"+j][i].lonlat[1],lon=a[g+":"+j][i].lonlat[0],color=a[g+":"+j][i].color,oppositeColor=a[g+":"+j][i].oppositeColor,stopLongName=a[g+":"+j][i].stopName,l[g+":"+j]=l[g+":"+j]||[],l[g+":"+j].push({dirTitle:h,lat:lat,lon:lon,minutes:c,route:g,userOrDest:i,color:color,oppositeColor:oppositeColor}))}}else"predictions"===b.name&&b.attr.dirTitleBecauseNoPredictions&&(h=b.attr.dirTitleBecauseNoPredictions,m.push({dirTitle:h,minutes:"?",route:g}));if(0===k){for(var n=0;n<m.length;n++)for(var o in l)if(o.slice(0,o.indexOf(":"))===m[n].route&&l[o].length<2&&l[o][0].dirTitle===m[n].dirTitle){var p=m[n];i="user"===l[o][0].userOrDest?"dest":"user",p.userOrDest=i,p.lat=a[o][i].lonlat[1],p.lon=a[o][i].lonlat[0],p.color=a[o][i].color,p.oppositeColor=a[o][i].oppositeColor,p.stopLongName=a[o][i].stopName,l[o].push(p)}lm.config.direction={};for(var q in l)if(2===l[q].length){var r=l[q][0];r.routeAndDirTag=q,e.lastStopObjArray.push(r),r=l[q][1],r.routeAndDirTag=q,e.lastStopObjArray.push(r),lm.config.direction[q]=!0}else delete l[q];e.adjustItemsOnMap(1),e.fetchAndRenderVehicles(),setTimeout(function(){e.getStopPredictions(a)},3e4),d.routesNotRendered&&d.getRouteObjFromServer(l)}})})},lm.App.prototype.adjustItemsOnMap=function(a){this.userloc&&this.addThings("user",a),this.destloc&&this.addThings("dest",a),this.addThings("bus",a),this.addThings("stop",a)},lm.App.prototype.addThings=function(a,b){var c,d=this,e=function(a){return a=new google.maps.LatLng(a.lat,a.lon),a=d.map.projection.fromLatLngToDivPixel(a),d3.select(this).transition().duration(1e4*b).style("left",a.x-lm.config.offset+"px").style("top",a.y-lm.config.offset+"px")},f={user:{r:10,layer:".userloclayer",data:this.userloc,svgClass:"usersvg",itemClass:"user",fill:"yellow"},dest:{r:10,layer:".destloclayer",data:this.destloc,svgClass:"destsvg",itemClass:"dest",fill:"yellow"},bus:{r:8,layer:".toplayer",data:this.lastBusArray,svgClass:"busContainer",itemClass:"bus"},stop:{r:9,layer:".stoplayer",data:this.lastStopObjArray,svgClass:"stopsvg",itemClass:"stop",fill:"white"}};if("bus"===a){c=d3.select(f[a].layer).selectAll("svg").data(f[a].data,function(a){return a.id}).each(e);var g=c.exit();g.selectAll("circle").transition().duration(2e3*b).style("opacity",0),g.selectAll("text").transition().duration(2e3*b).style("opacity",0),setTimeout(function(){g.remove()},2e3*b)}else if("stop"===a)c=d3.select(f[a].layer).selectAll("svg").data(f[a].data,function(a){return a.route+a.userOrDest}).each(e);else{if("user"!==a&&"dest"!==a)return;c=d3.select(f[a].layer).selectAll("svg").data(f[a].data).each(e)}var h=c.enter().append("svg").each(e).attr("class",f[a].svgClass);"stop"===a&&h.append("rect").attr("x",10).attr("y",5).attr("width",46).attr("height",10).style("fill","black");var i=h.append("circle").attr("r",f[a].r).attr("cx",10).attr("cy",10).attr("class",f[a].itemClass);if("user"===a&&h.append("text").attr("dy",".31em").attr("y",9).attr("x",1).text("You"),"dest"===a&&h.append("text").attr("dy",".31em").attr("y",9).attr("x",0).text("Dest"),"bus"===a?(i.transition().duration(2e3).style("fill-opacity",.9).style("fill",function(a){return d.map.allRouteColors[a.routeTag].color}),h.append("text").attr("x",lm.config.offset/2).attr("y",lm.config.offset).attr("dy",".31em").style("fill",function(a){return d.map.allRouteColors[a.routeTag].oppcolor}).text(function(a){return a.routeTag})):"stop"===a?i.style("fill",function(a){return a.color}):i.style("fill",f[a].fill),"stop"===a){h.append("text").attr("x",23).attr("y",10).attr("dy",".31em").attr("fill","white").attr("class","timetext");var j=d3.selectAll(".timetext").data(f[a].data,function(a){return a.route+a.userOrDest});j.text(function(a){return"user"===a.userOrDest?"?"===a.minutes?"???":a.minutes+" min":"end"}),j.style("fill",function(a){return"?"===a.minutes?"red":void 0}),h.append("text").attr("x",3).attr("y",10).attr("dy",".31em").attr("textLength","15px").attr("lengthAdjust","spacing").style("fill",function(a){return a.oppositeColor}).text(function(a){return a.route})}},lm.Map=function(a){var b=this;this.allRouteColors={1:{color:"cc6600",oppcolor:"000000"},2:{color:"000000",oppcolor:"ffffff"},3:{color:"339999",oppcolor:"000000"},5:{color:"666699",oppcolor:"ffffff"},6:{color:"996699",oppcolor:"000000"},9:{color:"889944",oppcolor:"000000"},10:{color:"b07d00",oppcolor:"000000"},12:{color:"b07d00",oppcolor:"000000"},14:{color:"339999",oppcolor:"000000"},17:{color:"003399",oppcolor:"ffffff"},18:{color:"996699",oppcolor:"000000"},19:{color:"000000",oppcolor:"ffffff"},21:{color:"660000",oppcolor:"ffffff"},22:{color:"ff6633",oppcolor:"000000"},23:{color:"b07d00",oppcolor:"000000"},24:{color:"996699",oppcolor:"000000"},27:{color:"660099",oppcolor:"ffffff"},28:{color:"000000",oppcolor:"ffffff"},29:{color:"ff6633",oppcolor:"000000"},30:{color:"990099",oppcolor:"ffffff"},31:{color:"339999",oppcolor:"000000"},33:{color:"660000",oppcolor:"ffffff"},35:{color:"ff6633",oppcolor:"000000"},36:{color:"003399",oppcolor:"ffffff"},37:{color:"000000",oppcolor:"ffffff"},38:{color:"ff6633",oppcolor:"000000"},39:{color:"ff6633",oppcolor:"000000"},41:{color:"b07d00",oppcolor:"000000"},43:{color:"006633",oppcolor:"ffffff"},44:{color:"ff6633",oppcolor:"000000"},45:{color:"006633",oppcolor:"ffffff"},47:{color:"667744",oppcolor:"ffffff"},48:{color:"cc6600",oppcolor:"000000"},49:{color:"b07d00",oppcolor:"000000"},52:{color:"889944",oppcolor:"000000"},54:{color:"cc0033",oppcolor:"ffffff"},56:{color:"990099",oppcolor:"ffffff"},59:{color:"cc3399",oppcolor:"ffffff"},60:{color:"4444a4",oppcolor:"ffffff"},61:{color:"9ac520",oppcolor:"000000"},66:{color:"666699",oppcolor:"ffffff"},67:{color:"555555",oppcolor:"ffffff"},71:{color:"667744",oppcolor:"ffffff"},88:{color:"555555",oppcolor:"ffffff"},90:{color:"660000",oppcolor:"ffffff"},91:{color:"667744",oppcolor:"ffffff"},108:{color:"555555",oppcolor:"ffffff"},F:{color:"555555",oppcolor:"ffffff"},J:{color:"cc6600",oppcolor:"000000"},KT:{color:"cc0033",oppcolor:"ffffff"},L:{color:"660099",oppcolor:"ffffff"},M:{color:"006633",oppcolor:"ffffff"},N:{color:"003399",oppcolor:"ffffff"},NX:{color:"006633",oppcolor:"ffffff"},"1AX":{color:"990000",oppcolor:"ffffff"},"1BX":{color:"cc3333",oppcolor:"ffffff"},"5L":{color:"666699",oppcolor:"ffffff"},"8X":{color:"996699",oppcolor:"000000"},"8AX":{color:"996699",oppcolor:"000000"},"8BX":{color:"996699",oppcolor:"000000"},"9L":{color:"889944",oppcolor:"000000"},"14L":{color:"009900",oppcolor:"ffffff"},"14X":{color:"cc0033",oppcolor:"ffffff"},"16X":{color:"cc0033",oppcolor:"ffffff"},"28L":{color:"009900",oppcolor:"ffffff"},"30X":{color:"cc0033",oppcolor:"ffffff"},"31AX":{color:"990000",oppcolor:"ffffff"},"31BX":{color:"cc3333",oppcolor:"ffffff"},"38AX":{color:"990000",oppcolor:"ffffff"},"38BX":{color:"cc3333",oppcolor:"ffffff"},"38L":{color:"009900",oppcolor:"ffffff"},"71L":{color:"009900",oppcolor:"ffffff"},"76X":{color:"009900",oppcolor:"ffffff"},"81X":{color:"cc0033",oppcolor:"ffffff"},"82X":{color:"cc0033",oppcolor:"ffffff"},"83X":{color:"cc0033",oppcolor:"ffffff"},"K OWL":{color:"198080",oppcolor:"ffffff"},"L OWL":{color:"330066",oppcolor:"ffffff"},"M OWL":{color:"004d19",oppcolor:"ffffff"},"N OWL":{color:"001980",oppcolor:"ffffff"},"T OWL":{color:"001980",oppcolor:"ffffff"}},this.routesNotRendered=!0;{var c=this.gMap=new google.maps.Map(document.querySelector(a.el),a),d=this.overlay=new google.maps.OverlayView;new google.maps.DirectionsService}d.draw=function(){lm.app.adjustItemsOnMap(0)},d.onAdd=function(){var d=d3.select(this.getPanes().overlayMouseTarget);b.projection=b.overlay.getProjection(),b.midpoint=b.gMap.getCenter(),b.busLayer=d.append("div").attr("class","toplayer"),b.routeLayer=d.append("div").attr("class","toplayerRoutes"),b.destloclayer=d.append("div").attr("class","destloclayer"),b.userLocLayer=d.append("div").attr("class","userloclayer"),b.stopLayer=d.append("div").attr("class","stoplayer"),this.draw(),e(!0,this),google.maps.event.addListener(c,"dragend",function(){var a=b.projection.fromLatLngToDivPixel(b.gMap.getCenter()),c=b.projection.fromLatLngToDivPixel(b.midpoint);(Math.abs(a.x-c.x)>window.innerWidth||Math.abs(a.y-c.y)>window.innerHeight)&&lm.app.fetchAndRenderVehicles()}),"function"==typeof a.ready&&a.ready()};var e=function(a){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(a){b.waitForDestinationClick(a,this.overlay)},function(a){3===a.code?(console.log("High accuracy not available"),e(!1)):alert("Please enable GPS.")},{enableHighAccuracy:a})};google.maps.event.addListenerOnce(c,"idle",function(){b.overlay.setMap(b.gMap)})},lm.Map.prototype.getBounds=function(){return this.gMap.getBounds()},lm.Map.prototype.waitForDestinationClick=function(a){{var b=this,c=!1,d=[a.coords.longitude,a.coords.latitude];new google.maps.LatLng(d[1],d[0])}lm.app.set("userloc",[{lat:d[1],lon:d[0]}]),lm.app.adjustItemsOnMap(0);var e=new google.maps.LatLng(d[1],d[0]);this.gMap.setCenter(e),google.maps.event.addListener(this.gMap,"click",function(a){lm.app.lastBusArray=[],c=!0,setTimeout(function(){if(c){google.maps.event.clearListeners(b.gMap,"click");var e=[a.latLng.lng(),a.latLng.lat()];lm.app.set("destloc",[{lon:e[0],lat:e[1]}]),lm.app.adjustItemsOnMap(0),b.sendCoordsToServer(d,e)}},400)}),google.maps.event.addListener(this.gMap,"dblclick",function(){c=!1})},lm.Map.prototype.sendCoordsToServer=function(a,b){var c=new XMLHttpRequest;c.open("POST","coordinates"),c.setRequestHeader("Content-Type","application/json"),c.onreadystatechange=function(){if(4==c.readyState&&200==c.status)try{var a=JSON.parse(c.responseText);Object.keys(a).length>0&&lm.app.getStopPredictions(a)}catch(b){console.error(b)}},c.send(JSON.stringify([a,b]))},lm.Map.prototype.getRouteObjFromServer=function(a){var b=JSON.stringify(a);d3.xhr("/findStopsOnRoutes").header("Content-Type","application/json").post(b,this.routify.bind(this))},lm.Map.prototype.routify=function(a,b){if(a)throw a;for(var c,d,e,f={},g={},h=this,i=lm.app.lastStopObjArray,j=0;j<i.length;j++)g[i[j].routeAndDirTag]=g[i[j].routeAndDirTag]||{},g[i[j].routeAndDirTag][i[j].userOrDest]=i[j];try{c=JSON.parse(b.responseText),this.routesNotRendered=!1}catch(k){console.error(k)}for(var l=function(a,b){var c=new google.maps.Polyline({path:a,strokeColor:b,strokeWeight:4});c.setMap(h.gMap)},m=0;m<c.length;m++)f[c[m].routeAndDirTag]||(e=!1,f[c[m].routeAndDirTag]={stops:[],color:c[m].color}),e||(d=new google.maps.LatLng(c[m].lonlat[1],c[m].lonlat[0]),f[c[m].routeAndDirTag].stops.push(d)),c[m].lonlat[0]===g[c[m].routeAndDirTag].dest.lon&&c[m].lonlat[1]===g[c[m].routeAndDirTag].dest.lat&&(e=!0);for(var n in f)l(f[n].stops,f[n].color)};
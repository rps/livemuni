/*! livemuni 07-11-2013 */
var lm={config:{map:{el:"#map-canvas",center:new google.maps.LatLng(37.783,-122.409),zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,styles:[{featureType:"poi.business",elementType:"all",stylers:[{visibility:"off"}]}]},offset:10,direction:"Outbound"},init:function(){lm.app=new lm.App(lm.config)},getDirection:function(){return"Outbound"===this.config.direction?"_OB":"_IB"},util:{}};lm.util.extend=function(){for(var a=arguments[0],b=1;b<arguments.length;b++)for(var c in arguments[b])a[c]=arguments[b][c];return a},lm.App=function(a){this.lastTime=0,this.lastBusArray=[],this.lastRouteArray=[],this.map=new lm.Map(lm.util.extend(a.map,{ready:this.setupMap.bind(this)}))},lm.App.prototype.setupMap=function(){this.generateAndRenderData(),setInterval(this.generateAndRenderData.bind(this),1e4)},lm.App.prototype.generateAndRenderData=function(){var a=this.map.getBounds(),b=a.getSouthWest(),c=a.getNorthEast(),d=(this.map.projection,this);d3.xhr("http://webservices.nextbus.com/service/publicXMLFeed?command=vehicleLocations&a=sf-muni&t=0",function(a,e){if(a)return console.error("Error: ",a),void 0;for(var f=[],g=new XmlDocument(e.response),h=0;h<g.children.length;h++)"lastTime"===g.children[h].name&&(d.lastTime=g.children[h].attr.time),b.lat()<=Number(g.children[h].attr.lat)&&Number(g.children[h].attr.lat)<=c.lat()&&b.lng()<=Number(g.children[h].attr.lon)&&Number(g.children[h].attr.lon)<=c.lng()&&g.children[h].attr.secsSinceReport&&g.children[h].attr.secsSinceReport<180&&g.children[h].attr.dirTag&&g.children[h].attr.dirTag.indexOf(lm.getDirection())>-1&&f.push(g.children[h].attr);d.lastBusArray=f,d.bussify(1)})},lm.App.prototype.getStopPredictions=function(a){var b="http://webservices.nextbus.com/service/publicXMLFeed?command=predictionsForMultiStops&a=sf-muni",c=this.map,d=this;for(var e in a)b+="&stops="+e+"|"+a[e].stopTag;d3.xhr(b,function(b,e){b&&console.log("Prediction error: ",b);var f=new XmlDocument(e.response),g={counter:f.children.length};f.eachChild(function(b){if(g.counter--,b.children.length>0&&"message"!==b.children[0].name){var e=b.attr.routeTag,f=new google.maps.LatLng(a[e].lonlat[1],a[e].lonlat[0]),h=b.children[0].children[0].attr.minutes;g[e]={latLng:f,minutes:h}}0===g.counter&&(delete g.counter,d.lastStopObj=g,d.updateOrAddSVG(g,".stoplayer","stopsvg","stop","yellow"),setTimeout(function(){d.getStopPredictions(a)},3e4),c.routesNotRendered&&c.getRoutesFromServer(Object.keys(g)))})})},lm.App.prototype.updateOrAddSVG=function(a,b,c,d,e){var f,g,h=[],i=this.map.projection,j=d3.select(b).selectAll("svg"),k=!(a instanceof google.maps.LatLng);if(k){for(var l in a){var m=i.fromLatLngToDivPixel(a[l].latLng);h.push({x:m.x,y:m.y,route:l,time:a[l].minutes})}j=j.data(h,function(a){return a.route})}else h.push(i.fromLatLngToDivPixel(a)),j=j.data(h);f=j.enter().append("svg").style("top",function(a){return a.y-10}).style("left",function(a){return a.x-10}).attr("class",c),k&&f.append("rect").attr("x",10).attr("y",5).attr("width",40).attr("height",10).style("fill","black"),g=f.append("circle").attr("r",8).attr("cx",10).attr("cy",10).attr("class",d).style("fill",e),k&&(timeLeft=f.append("text").attr("x",20).attr("y",10).attr("dy",".31em").attr("fill","white").attr("class","timetext"),d3.selectAll(".timetext").data(h,function(a){return a.route}).text(function(a){return a.time+" min"}),f.append("text").attr("x",4).attr("y",10).attr("dy",".31em").attr("fill","black").text(function(a){return a.route}))},lm.App.prototype.bussify=function(a){var b=this,c=this.lastBusArray,d=function(c){return c=new google.maps.LatLng(c.lat,c.lon),c=b.map.projection.fromLatLngToDivPixel(c),d3.select(this).transition().duration(1e4*a).style("left",c.x-lm.config.offset+"px").style("top",c.y-lm.config.offset+"px")},e=d3.select(".toplayer"),f=e.selectAll(".busContainer").data(c,function(a){return a.id}).each(d),g=f.exit();g.selectAll("circle").transition().duration(2e3*a).style("opacity",0),g.selectAll("text").transition().duration(2e3*a).style("opacity",0),setTimeout(function(){g.remove()},2e3*a);{var h=f.enter().append("svg").each(d).attr("class","busContainer");h.append("circle").transition().duration(2e3*a).attr("r",8).attr("cx",lm.config.offset).attr("cy",lm.config.offset).attr("class","bus").style("fill-opacity",.7).style("stroke-width","1.5px").style("fill",function(){return"#"+(~~(Math.random()*(1<<24))).toString(16)}),h.append("text").attr("x",lm.config.offset/2).attr("y",lm.config.offset).attr("dy",".31em").attr("fill","black").text(function(a){return a.routeTag})}},lm.Map=function(a){var b=this;this.routesNotRendered=!0;{var c=window.map=this.gMap=new google.maps.Map(document.querySelector(a.el),a),d=window.overlay=this.overlay=new google.maps.OverlayView;window.directionsService=new google.maps.DirectionsService}d.draw=function(){lm.app.bussify(0)},d.onAdd=function(){var c=d3.select(this.getPanes().overlayMouseTarget);b.projection=b.overlay.getProjection(),b.busLayer=c.append("div").attr("class","toplayer"),b.routeLayer=c.append("div").attr("class","toplayerRoutes"),b.clickLayer=c.append("div").attr("class","clicklayer"),b.userLocLayer=c.append("div").attr("class","userloclayer"),b.stopLayer=c.append("div").attr("class","stoplayer"),this.draw(),e(!0,this),"function"==typeof a.ready&&a.ready()};var e=function(a){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(a){b.waitForDestinationClick(a,this.overlay)},function(a){3===a.code?(console.log("High accuracy not available"),e(!1)):console.log("Please enable GPS.")},{enableHighAccuracy:a})};google.maps.event.addListenerOnce(c,"idle",function(){b.overlay.setMap(b.gMap)})},lm.Map.prototype.getBounds=function(){return this.gMap.getBounds()},lm.Map.prototype.waitForDestinationClick=function(a){var b=this;a={coords:{latitude:37.783594,longitude:-122.408904}};var c=[-122.408904,37.783594],d=new google.maps.LatLng(c[1],c[0]);lm.app.updateOrAddSVG(d,".userloclayer","usersvg","user","blue");var e=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);this.gMap.setCenter(e),google.maps.event.addListener(map,"click",function(a){var d=[a.latLng.lng(),a.latLng.lat()];lm.config.direction=d[0]<c[0]?"Outbound":"Inbound",lm.app.updateOrAddSVG(a.latLng,".clicklayer","clicksvg","dest","black"),b.sendCoordsToServer(c,d)})},lm.Map.prototype.sendCoordsToServer=function(a,b){var c=new XMLHttpRequest;c.open("POST","coordinates"),c.setRequestHeader("Content-Type","application/json"),c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){console.log("Reply received from server");try{var a=JSON.parse(c.responseText);lm.app.getStopPredictions(a)}catch(b){console.error(b)}}},c.send(JSON.stringify([a,b,lm.config.direction]))},lm.Map.prototype.getRoutesFromServer=function(a){var b={};b[lm.config.direction]=a;var c=JSON.stringify(b);d3.xhr("/routify").header("Content-Type","application/json").post(c,this.routify.bind(this))},lm.Map.prototype.routify=function(a,b){if(a)throw a;var c,d,e,f=this;try{c=JSON.parse(b.responseText),this.routesNotRendered=!1}catch(g){console.error(g)}for(var h=function(a){d=0,e=0;for(var b=0;b<a.length;b++){for(var c in a[b])a[b][c]>0?d=a[b][c]:e=a[b][c];a[b]=new google.maps.LatLng(d,e)}var g=new google.maps.Polyline({path:a,strokeColor:"#F08080",strokeWeight:4});g.setMap(f.gMap)},i=0;i<c.length;i++)for(var j=0;j<c[i].path.length;j++)h(c[i].path[j].routes[0].overview_path)};